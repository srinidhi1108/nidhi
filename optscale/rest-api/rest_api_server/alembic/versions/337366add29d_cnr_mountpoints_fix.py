""""cnr_mountpoints_fix"

Revision ID: 337366add29d
Revises: 2064620faa49
Create Date: 2018-07-17 11:11:44.253006

"""
import json
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import mysql
from sqlalchemy import and_
from sqlalchemy.orm import Session

# revision identifiers, used by Alembic.
revision = '337366add29d'
down_revision = '2064620faa49'
branch_labels = None
depends_on = None
new_cnr_mountpoint = json.dumps({
    "type": "cloud_agent",
    "url": "%URL%",
    "offset": "%OFFSET%",
    "device": "%DEVICE%"
})
old_cnr_mountpoint = '{"device": "%DEVICE%", "offset": %OFFSET%, "url": "%URL%", "type": "cloud_agent"}'


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    update_mountpoint(new_cnr_mountpoint)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    update_mountpoint(old_cnr_mountpoint)
    # ### end Alembic commands ###


def update_mountpoint(mountpoint):
    bind = op.get_bind()
    session = Session(bind=bind)
    mountpoint_table = sa.table('mountpoint',
                                sa.Column('is_cnr', sa.Boolean()),
                                sa.Column('deleted_at', sa.Integer()),
                                sa.Column('mountpoint', sa.TEXT()))
    try:
        upd_stmt = sa.update(mountpoint_table).values(
            mountpoint=mountpoint).where(
            and_(
                mountpoint_table.c.deleted_at == 0,
                mountpoint_table.c.is_cnr.is_(True)
            ))
        session.execute(upd_stmt)
        session.commit()
    finally:
        session.close()
