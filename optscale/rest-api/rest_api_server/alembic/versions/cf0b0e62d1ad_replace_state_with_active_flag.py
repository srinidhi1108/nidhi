""""replace state with active flag"

Revision ID: cf0b0e62d1ad
Revises: 493a8b74dce8
Create Date: 2020-07-13 18:10:06.535224

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy import table, column, update

# revision identifiers, used by Alembic.
from sqlalchemy.orm import Session

revision = 'cf0b0e62d1ad'
down_revision = '493a8b74dce8'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
    session = Session(bind=bind)
    op.add_column('rule', sa.Column('active', sa.Boolean(),
                                    default=False, nullable=False))
    table_ = table('rule',
                   column('id', sa.String(36)),
                   column('active', sa.Boolean()),
                   column('state', sa.Enum('ACTIVE', 'INVALID', 'INACTIVE')))
    upd_stmt1 = update(table_).values(active=True).where(
        table_.c.state == 'ACTIVE')
    upd_stmt2 = update(table_).values(active=False).where(
        table_.c.state == 'INACTIVE')
    try:
        session.execute(upd_stmt1)
        session.execute(upd_stmt2)
        session.commit()
    finally:
        session.close()
    op.drop_column('rule', 'state')
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
    session = Session(bind=bind)
    op.add_column('rule',
                  sa.Column('state', sa.Enum('ACTIVE', 'INVALID', 'INACTIVE'),
                            nullable=False))
    table_ = table('rule',
                   column('id', sa.String(36)),
                   column('active', sa.Boolean()),
                   column('state', sa.Enum('ACTIVE', 'INVALID', 'INACTIVE')))

    upd_stmt1 = update(table_).values(state='ACTIVE').where(
        table_.c.active.is_(True))
    upd_stmt2 = update(table_).values(state='INACTIVE').where(
        table_.c.active.is_(False))
    try:
        session.execute(upd_stmt1)
        session.execute(upd_stmt2)
        session.commit()
    finally:
        session.close()
    op.drop_column('rule', 'active')
    # ### end Alembic commands ###
