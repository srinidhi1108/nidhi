""""“customer_add_strict_partner_id”"

Revision ID: 01bfee5f7666
Revises: eb2dc922a243
Create Date: 2017-06-19 09:30:51.656108

"""
from alembic import op
import sqlalchemy as sa
import uuid
from sqlalchemy.dialects import mysql
from sqlalchemy.orm import Session
from sqlalchemy.sql import table, column
from sqlalchemy import update, String, Integer, select, insert, func

# revision identifiers, used by Alembic.
revision = '01bfee5f7666'
down_revision = '2a05edaa221a'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
    session = Session(bind=bind)
    customer_table = table(
        "customer", column('partner_id', sa.String()))
    sql = select([func.count()]).select_from(customer_table).where(
        customer_table.c.partner_id.is_(None))
    try:
        count = session.execute(sql).scalar()
        if count:
            partner_table = table(
                'partner', column('id', String()),
                column('deleted_at', Integer()),
                column('name', String()),
                column('email', String())
            )
            stmt = select([partner_table]).where(
                partner_table.c.deleted_at == 0)
            partner_id = session.execute(stmt).scalar()
            if not partner_id:
                partner_id = str(uuid.uuid4())
                ins_stmt = insert(partner_table).values(
                    name='Hystax',
                    email='support@hystax.com',
                    id=partner_id,
                    deleted_at=0
                )
                session.execute(ins_stmt)
            upd_partner_id = update(customer_table).values(
                partner_id=partner_id).where(
                customer_table.c.partner_id.is_(None))
            session.execute(upd_partner_id)
        session.commit()
    finally:
        session.close()
    op.drop_constraint('customer_ibfk_1', 'customer', type_='foreignkey')
    op.alter_column('customer', 'partner_id',
                    existing_type=String(36), nullable=False)
    op.create_foreign_key('customer_ibfk_1', 'customer', 'partner',
                          ['partner_id'], ['id'])
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('customer', 'partner_id',
                    existing_type=sa.String(length=36), nullable=True)
    # ### end Alembic commands ###
